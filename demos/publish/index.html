<!doctype html>
<html lang="en">
<head>
  <meta charset=utf-8>
  <!--
   | Copyright 2019 Esri
   |
   | Licensed under the Apache License, Version 2.0 (the "License");
   | you may not use this file except in compliance with the License.
   | You may obtain a copy of the License at
   |
   |    http://www.apache.org/licenses/LICENSE-2.0
   |
   | Unless required by applicable law or agreed to in writing, software
   | distributed under the License is distributed on an "AS IS" BASIS,
   | WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   | See the License for the specific language governing permissions and
   | limitations under the License.
  -->
  <title>Publish solution template</title>
  <link rel="stylesheet" type="text/css" href="../demo_common/common.css">
</head>
<body>
  <h3>Publish solution template</h3>
  <div id="page" style="display:none">

    <div class="section">
      <div class="section-title">Credentials in source organization for Solution items</div>
      <label for="srcUsername">Username:</label> <input type="text" id="srcUsername">
      <label for="srcPassword">Password:</label> <input type="password" id="srcPassword">
      <label for="srcPortal">Portal:</label>
      <input type="text" id="srcPortal" style="width:256px" placeholder="https://myorg.maps.arcgis.com">
      <br/><br/>
      <div class="section-title">Credentials in destination organization for Solution template</div>
      <label for="destUsername">Username:</label> <input type="text" id="destUsername">
      <label for="destPassword">Password:</label> <input type="password" id="destPassword">
      <label for="destPortal">Portal:</label>
      <input type="text" id="destPortal" style="width:256px" placeholder="https://myorg.maps.arcgis.com">
    </div>

    <div class="section">
      <div class="section-title">Drag & drop URLs of top-level items to package into a single Solution
        (their dependencies are automatically included)</div>
      <div><i>e.g., https://myorg.maps.arcgis.com/home/item.html?id=1af7db9a03b54d5793d6f79ce12ef030</i></div>
      <div><i>Please only use drag & drop; editing the contents of the box below will not work</i></div>

      <textarea id="itemLinksText" rows="2" cols="115" ondrop="onDrop(event)"></textarea>

      <br/><br/>
      <button id="clearBtn" onclick="clearList()">Clear list</button>
      <button id="createBtn" onclick="createSolutionFcn()">Create solution</button>
    </div>

    <div id="create" class="section" style="display:none">
      <div class="section-title">Solution ready for publishing</div>
      <img id="creating" src="../demo_common/images/loading.gif"/>
      <div id="createResults" style="display:none">
        <div id="createDisplay"></div>
        <br>
        <label for="solutionName">Name for published Solution:</label>
        <input type="text" id="solutionName" style="width:300px" placeholder="Solution"><br>
        <button id="publishBtn" onclick="publishSolutionFcn()">Publish solution</button>
      </div>
    </div>

    <div id="display" class="section" style="display:none">
      <div class="section-title">Published Solution details</div>
      <img id="fetchingDetails" src="../demo_common/images/loading.gif"/>
      <div id="detailsResults" style="display:none">
        <div id="detailsDisplay"></div>
      </div>
    </div>

  </div>

  <script src="../demo_common/require_2.3.6.min.js"></script>
  <script src="../lib/arcgis-rest-auth.js"></script>
  <script src="../lib/arcgis-rest-items.js"></script>
  <script src="../lib/arcgis-rest-request.js"></script>
  <script src="../lib/arcgis-clone-js.js"></script>
  <script>
  var createSolutionFcn = publishSolutionFcn = null;

  function clearList() {
    document.getElementById('itemLinksText').textContent = '';
    document.getElementById('itemLinksText').rows = 2;

    document.getElementById('create').style.display = 'none';
    document.getElementById('createResults').style.display = 'none';
    document.getElementById('createDisplay').innerHTML = '';
    document.getElementById('publishBtn').disabled = 'disabled';

    document.getElementById('display').style.display = 'none';
    document.getElementById('detailsResults').style.display = 'none';
    document.getElementById('detailsDisplay').innerHTML = '';
  }

  // -----------------
  // https://developer.mozilla.org/en-US/docs/Web/API/HTML_Drag_and_Drop_API
  // "Any copyright is dedicated to the Public Domain. http://creativecommons.org/publicdomain/zero/1.0/"
  function contains(list, value) {
    for( var i = 0; i < list.length; ++i ) {
      if(list[i] === value) return true;
    }
    return false;
  }
  // -----------------

  function onDrop(event) {
    if (contains(event.dataTransfer.types, 'text/uri-list')) {
      var data = event.dataTransfer.getData('text/uri-list');
      if (event.target.textContent.length > 0) {
        event.target.textContent += '\n';
      }
      event.target.textContent += data;
      event.target.rows++;
    }
    event.preventDefault();
  }

  requirejs([
    '../demo_common/common',
    '../demo_common/polyfills'
  ], function (
    demoCommon
  ) {
    createSolutionFcn = createSolution;
    publishSolutionFcn = publishSolution;
    var requestOptions, templatesList, solutionName;

    document.getElementById('page').style.display = 'block';


    //----------------------------------------------------------------------------------------------------------------//

    /**
     * Gets the selected source item from the UI.
     */
    function getCheckedItem() {
      var selection;
      Array.prototype.slice.call(document.getElementsByTagName('input')).forEach(function (item) {
        if (item.type === 'radio' && item.checked) {
          selection = item;
        }
      });
      return selection;
    }

    /**
     * Creates a solution from a set of existing AGOL items
     */
    function createSolution() {
      document.getElementById('create').style.display = 'block';

      document.getElementById('creating').style.display = 'block';
      document.getElementById('createResults').style.display = 'none';

      // Prepare credentials for source
      sourceRequestOptions = demoCommon.getRequestOptions(
        document.getElementById('srcUsername').value, document.getElementById('srcPassword').value,
        document.getElementById('srcPortal').value + '/sharing/rest');

      // Prepare credentials for destination
      destinationRequestOptions = demoCommon.getRequestOptions(
        document.getElementById('destUsername').value, document.getElementById('destPassword').value,
        document.getElementById('destPortal').value + '/sharing/rest');

      // Get the source's organization URL for creating links to source items
      arcgis_rest_request.getPortal(null, sourceRequestOptions)
      .then(
        function (response) {
          var orgUrl = 'https://' + response.urlKey + '.' + response.customBaseUrl + '/home/';
          var portalUrl = 'https://' + response.portalHostname + '/';

          // Get the items to include in the solution, then generate the solution
          var urlsList = document.getElementById('itemLinksText').textContent.split('\n');
          var solutionRootIds = urlsList.map(
            function (line) {
              var urlSplit = line.split('/home/item.html?id=');
              if (urlSplit.length === 2) {
                return urlSplit[1];
              }
              return null;
            }
          ).filter(
            function (id) {
              return id;
            }
          );
          console.log(JSON.stringify(solutionRootIds,null,2));

          // Get the items forming the solution
          arcgis_clone_js.createSolution(solutionRootIds, sourceRequestOptions)
          .then(
            response => {
              templatesList = response;

              // Display the Solution
              document.getElementById('createDisplay').innerHTML = 'Source hierarchy:' +
                demoCommon.createHierarchyDisplay(templatesList,
                arcgis_clone_js.getItemHierarchy(templatesList), true, orgUrl);
              document.getElementById('publishBtn').disabled = '';
            },
            error => {
              document.getElementById('createDisplay').innerHTML = JSON.stringify(error);
              document.getElementById('publishBtn').disabled = 'disabled';
            }
          )
          .finally(
            () => {
              document.getElementById('creating').style.display = 'none';
              document.getElementById('createResults').style.display = 'block';
            }
          );

        },
        function (error) {
          console.warn(JSON.stringify(error));
          document.getElementById('create').style.display = 'none';
          alert('Please refresh page and provide credentials');
        }
      );
    }

    /**
     * Creates a solution item in the user's organization.
     */
    function publishSolution() {
      document.getElementById('publishBtn').disabled = 'disabled';
      document.getElementById('display').style.display = 'block';

      // Get the destinations's organization URL for creating links to source items
      arcgis_rest_request.getPortal(null, destinationRequestOptions)
      .then(
        function (response) {
          var orgUrl = 'https://' + response.urlKey + '.' + response.customBaseUrl + '/home/';
          var portalUrl = 'https://' + response.portalHostname + '/';

          // Publish the Solution
          solutionName = document.getElementById('solutionName').value || 'Solution';
          arcgis_clone_js.publishSolution(solutionName, templatesList, destinationRequestOptions, null, 'public')
          .then(function (publishResponse) {
            var publishedSolutionId = publishResponse.id;

            arcgis_rest_items.getItemData(publishedSolutionId, destinationRequestOptions)
            .then(
              publishedSolution => {
                document.getElementById('detailsDisplay').innerHTML =
                  demoCommon.createItemLinksDisplay(publishedSolutionId, orgUrl, portalUrl) +
                  '<br>Published Solution item hierarchy:' +
                  demoCommon.createHierarchyDisplay(publishedSolution.templates,
                    arcgis_clone_js.getItemHierarchy(publishedSolution.templates));
              }
            );
          }, function (error) {
             document.getElementById('detailsDisplay').innerHTML = JSON.stringify(error);
          })
          .finally(() => {
            document.getElementById('fetchingDetails').style.display = 'none';
            document.getElementById('detailsResults').style.display = 'block';
          });
        }
      );
    }

    //----------------------------------------------------------------------------------------------------------------//

  });
  </script>
</body>
</html>
