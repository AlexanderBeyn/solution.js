/* @preserve
* arcgis-clone-js - v0.4.0 - Apache-2.0
* Copyright (c) 2018-2019 Esri, Inc.
* Mon Mar 11 2019 11:38:18 GMT-0700 (Pacifique (heure d’été))
*/
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.arcgisClone=e.arcgisClone||{})}(this,function(e){"use strict";var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,n)};var n=function(){return(n=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)};const r=(e,t,n)=>t.split(".").reduce((e,t)=>e?e[t]:n,e);function i(e,t){return Object.keys(e).reduce(function(n,r){return n[r]=t(e[r],r,e),n},{})}const o=e=>e instanceof Date,a=e=>"function"==typeof e,u=e=>"object"==typeof e,s=e=>e instanceof RegExp;const c=e=>"object"==typeof e;function f(e,t){if(t=t||"",Array.isArray(e)){return function(e){let t=e,n=e.reduce((e,t)=>{if(l(t)&&m(t)){let n=d(t);n>e&&(e=n)}return e},-1);n>-1&&(t=0===n?[]:`{{delete:${n-1}}}`);return t}(e.map(n).filter(e=>null!==e&&void 0!==e))}return e&&c(e)?function(e){let t,n=Object.keys(e).reduce((t,n)=>{let r=e[n];if(l(r)&&m(r)){let e=d(r);e>t.maxLevel&&(t.maxLevel=e)}else t.obj[n]=r;return t},{obj:{},maxLevel:-1});t=n.maxLevel>0?1===n.maxLevel?void 0:`{{delete:${n.maxLevel-1}}}`:n.obj;return t}(i(e,n)):function(e){let t=e;"string"==typeof e&&m(e)&&(t=function(e){let t=e,n=d(e);t=0===n?void 0:`{{delete:${n}}}`;return t}(e));return t}(e);function n(e,n){return f(e,t?t+"."+n:n)}}const d=e=>parseInt(e.replace(/{|}/g,"").split(":")[1]);function m(e){return!(!e||"string"!=typeof e)&&e.indexOf("{{delete")>-1}const l=e=>"string"==typeof e;function p(e,t,n,r=0){let i=t;return t||(i=`{{delete:${r}}}`),i}const h=/{{\s*?[\w].*?}}/g,y=e=>"string"==typeof e;function v(e,t,n=null){if((n=n||{}).optional)throw new Error("Please do not pass in an `optional` transform; adlib provides that internally.");return n.optional=p,f(function e(t,n,r){if(r=r||"",Array.isArray(t))return t.map(c);if(!t||!u(t)||o(t)||s(t)||a(t))return n(t,r);return Object.assign({},t,i(t,c));function c(t,i){return e(t,n,r?r+"."+i:i)}}(e,function(e,i){if(!y(e))return e;var o;let a=e.match(h);if(a&&a.length){let i=!1;return a.map(e=>{let o=e.replace(/{|}/g,"").trim();if(o.indexOf("||")>-1){var a=o.split("||").map(e=>e.trim());let e=a.length;o=a.find((n,o)=>{return function(e,t){let n=e.split(":")[0],i=r(t,n,null);return null!==i&&void 0!==i}(n,t)?n:o+1===e&&(i=!0,isNaN(n)||(n=parseInt(n)),n)})}let u={key:e,value:o};return i||(u.value=function(e,t,n){let i,o=e.split(":");if(o.length>1){let a=o[0],u=o[1],s=null;if(o[2]&&(s=o[2]),!n||!n[u]||"function"!=typeof n[u])throw new Error(`Attempted to apply non-existant transform ${u} on ${a} with params ${e}`);i=r(t,a),i=n[u](a,i,t,s)}else i=r(t,e);return i}(o,t,n)||e),u}).forEach(t=>{e===t.key?("string"==typeof t.value&&(isNaN(t.value)||(t.value.indexOf(".")>-1?t.value=parseFloat(t.value):t.value=parseInt(t.value))),o=t.value):e=e.replace(t.key,t.value)}),o||e}return e}))}function g(e){return Object.keys(e).some(function(t){var n=e[t];if(!n)return!1;switch(n.constructor.name){case"Array":case"Object":case"Date":case"Function":case"Boolean":case"String":case"Number":return!1;default:return!0}})}function I(e){var t={};return Object.keys(e).forEach(function(n){var r=e[n];if(r||0===r||"boolean"==typeof r||"string"==typeof r){var i;switch(r.constructor.name){case"Array":i=r[0]&&r[0].constructor&&"Object"===r[0].constructor.name?JSON.stringify(r):r.join(",");break;case"Object":i=JSON.stringify(r);break;case"Date":i=r.valueOf();break;case"Function":i=null;break;case"Boolean":i=r+"";break;default:i=r}(i||0===i||"string"==typeof i)&&(t[n]=i)}}),t}function w(e){var t=I(e);return Object.keys(t).map(function(e){return function(e,t){return encodeURIComponent(e)+"="+encodeURIComponent(t)}(e,t[e])}).join("&")}var b=function(){return function(e,t,n,r,i){e=e||"UNKNOWN_ERROR",t=t||"UNKNOWN_ERROR_CODE",this.name="ArcGISRequestError",this.message="UNKNOWN_ERROR_CODE"===t?e:t+": "+e,this.originalMessage=e,this.code=t,this.response=n,this.url=r,this.options=i}}();b.prototype=Object.create(Error.prototype),b.prototype.constructor=b;var O="@esri/arcgis-rest-js";function T(e,t){void 0===t&&(t={params:{f:"json"}});var r=n({httpMethod:"POST"},t),i=[],o=[];if(r.fetch||"undefined"==typeof fetch?(i.push("`fetch`"),o.push("`isomorphic-fetch`")):r.fetch=fetch.bind(Function("return this")()),"undefined"==typeof Promise&&(i.push("`Promise`"),o.push("`es6-promise`")),"undefined"==typeof FormData&&(i.push("`FormData`"),o.push("`isomorphic-form-data`")),!r.fetch||"undefined"==typeof Promise||"undefined"==typeof FormData)throw new Error("`arcgis-rest-request` requires global variables for `fetch`, `Promise` and `FormData` to be present in the global scope. You are missing "+i.join(", ")+". We recommend installing the "+o.join(", ")+" modules at the root of your application to add these to the global scope. See https://bit.ly/2KNwWaJ for more info.");var a=r.httpMethod,u=r.authentication,s=r.rawResponse,c=n({f:"json"},t.params),f={method:a,credentials:"same-origin"};return(u?u.getToken(e,{fetch:r.fetch}):Promise.resolve("")).then(function(i){if(i.length&&(c.token=i),"GET"===f.method){var o=""===w(c)?e:e+"?"+w(c);r.maxUrlLength&&o.length>r.maxUrlLength?f.method="POST":e=o}return"POST"===f.method&&(f.body=function(e){var t=g(e),n=I(e);if(t){var r=new FormData;return Object.keys(n).forEach(function(e){if("undefined"!=typeof Blob&&n[e]instanceof Blob){var t=n.fileName||n[e].name||e;r.append(e,n[e],t)}else r.append(e,n[e])}),r}return w(e)}(c)),f.headers=n({},t.headers),"undefined"!=typeof window||f.headers.referer||(f.headers.referer=O),g(c)||(f.headers["Content-Type"]="application/x-www-form-urlencoded"),r.fetch(e,f)}).then(function(t){if(!t.ok){var n=t.status,i=t.statusText;throw new b(i,"HTTP "+n,t,e,r)}if(s)return t;switch(c.f){case"json":case"geojson":return t.json();case"html":case"text":return t.text();default:return t.blob()}}).then(function(t){return"json"!==c.f&&"geojson"!==c.f||s?t:function(e,t,n,r){if(e.code>=400){var i=e.message,o=e.code;throw new b(i,o,e,t,r)}if(e.error){var a=e.error,i=a.message,o=a.code,u=a.messageCode,s=u||o||"UNKNOWN_ERROR_CODE";if(498===o||499===o||"GWM_0003"===u)throw new P(i,s,e,t,r);throw new b(i,s,e,t,r)}if("failed"===e.status||"failure"===e.status){var i=void 0,o="UNKNOWN_ERROR_CODE";try{i=JSON.parse(e.statusMessage).message,o=JSON.parse(e.statusMessage).code}catch(t){i=e.statusMessage||e.message}throw new b(i,o,e,t,r)}return e}(t,e,0,r)})}var E,P=function(e){function r(t,n,r,i,o){void 0===t&&(t="AUTHENTICATION_ERROR"),void 0===n&&(n="AUTHENTICATION_ERROR_CODE");var a=e.call(this,t,n,r,i,o)||this;return a.name="ArcGISAuthError",a.message="AUTHENTICATION_ERROR_CODE"===n?t:n+": "+t,a}return function(e,n){function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}(r,e),r.prototype.retry=function(e,t){var r=this;void 0===t&&(t=3);var i=0,o=function(a,u){e(r.url,r.options).then(function(e){var t=n({},r.options,{authentication:e});return i+=1,T(r.url,t)}).then(function(e){a(e)}).catch(function(e){"ArcGISAuthError"===e.name&&i<t?o(a,u):"ArcGISAuthError"===e.name&&i>=t?u(r):u(e)})};return new Promise(function(e,t){o(e,t)})},r}(b);function A(e){return"/"===(e=e.trim())[e.length-1]&&(e=e.slice(0,-1)),e}function k(e){return void 0===e&&(e={}),e.portal?A(e.portal):e.authentication?e.authentication.portal:"https://www.arcgis.com/sharing/rest"}function R(e){var t=JSON.parse(JSON.stringify(e)),n=e.typeKeywords,r=void 0===n?[]:n,i=e.tags,o=void 0===i?[]:i;return t.typeKeywords=r.join(", "),t.tags=o.join(", "),t.data&&(t.text=JSON.stringify(t.data),delete t.data),t.properties&&(t.properties=JSON.stringify(t.properties)),t}function S(e){return e.owner?e.owner:e.item&&e.item.owner?e.item.owner:e.authentication.username}function x(e){var t=S(e),r=k(e)+"/content/users/"+t,i=r+"/addItem";return e.folder&&(i=r+"/"+e.folder+"/addItem"),e.params=n({},e.params,R(e.item)),T(i,e)}function j(e){var t=S(e),r=k(e)+"/content/users/"+t+"/items/"+e.item.id+"/update";return e.params=n({},e.params,R(e.item)),T(r,e)}function C(e){var t,r,i,o,a=k(e)+"/community/createGroup",u=n({},e);return u.params=(t=e.group,r=JSON.parse(JSON.stringify(t)),i=t.tags,o=void 0===i?[]:i,r.tags=o.join(", "),r),T(a,u)}function _(e,t){return T(k(t)+"/community/groups/"+e,n({httpMethod:"GET"},t))}function D(e){return e.authentication.getUser(e).then(function(e){return!(!e||"org_admin"!==e.role)})}function F(e){var t=function(e){var t=e.authentication.username,n=e.owner||t;return k(e)+"/content/users/"+encodeURIComponent(n)+"/items/"+e.id+"/share"}(e);return function(e){var t=e.authentication.username;return(e.owner||t)===t}(e)?N(t,e):D(e).then(function(n){if(n)return N(t,e);throw Error("This item can not be shared by "+e.authentication.username+". They are neither the item owner nor an organization admin.")})}function N(e,t){return t.params=n({org:!1,everyone:!1},t.params),"private"===t.access&&(t.params.groups=" "),"org"===t.access&&(t.params.org=!0),"public"===t.access&&(t.params.org=!0,t.params.everyone=!0),T(e,t)}function U(e){return function(e){var t=e.authentication.username,r=e.owner||t;return D(e).then(function(i){var o="share"===e.action?"notSharedWith":"notUnsharedFrom";return function(e){var t={q:"id: "+e.id+" AND group: "+e.groupId,start:1,num:10,sortField:"title"},r=n({},e,{rawResponse:!1});return r.params=n({},t,e.params),T(k(r)+"/search",r).then(function(t){return 0!==t.total&&(t.results.some(function(t){var r=t.id===e.id;return r&&(n=t),r}),!!n);var n})}(e).then(function(n){if("share"===e.action&&!0===n||"unshare"===e.action&&!1===n){var a={itemId:e.id,shortcut:!0};return a[o]=[],a}return function(e){return _(e.groupId,e).then(function(e){return e.userMembership.memberType}).catch(function(){return"nonmember"})}(e).then(function(n){if("nonmember"===n)throw Error("This item can not be "+e.action+"d by "+t+" as they are not a member of the specified group "+e.groupId+".");if(r===t)return k(e)+"/content/users/"+r+"/items/"+e.id+"/"+e.action;if("admin"===n||"owner"===n||i)return k(e)+"/content/items/"+e.id+"/"+e.action;throw Error("This item can not be "+e.action+"d by "+t+" as they are neither the owner, a groupAdmin of "+e.groupId+", nor an org_admin.")}).then(function(t){return e.params={groups:e.groupId,confirmItemControl:e.confirmItemControl},T(t,e)}).then(function(t){if(t[o].length)throw Error("Item "+e.id+" could not be "+e.action+"d to group "+e.groupId+".");return t})})})}(n({action:"share"},e))}!function(e){e.ArcGISRequestError="ArcGISRequestError",e.ArcGISAuthError="ArcGISAuthError"}(E||(E={}));var L="{{organization.portalBaseUrl}}";function G(e){return e?{success:!1,error:e.error||e}:{success:!1}}function W(e){e.item.extent&&(e.item.extent="{{initiative.extent:optional}}"),e.item.id=H(e.item.id)}function M(e,t,r,i,o){return void 0===i&&(i=null),void 0===o&&(o="private"),new Promise(function(a,u){var s=n({item:e,folder:i},r);t&&(s.item.text=t),x(s).then(function(t){(delete e.text,"private"!==o)?F(n({id:t.id,access:o},r)).then(function(e){a({success:!0,id:e.itemId})},function(e){return u(G(e))}):a({success:!0,id:t.id})},function(e){return u(G(e))})})}function z(e){return Array.isArray(e)?e.map(function(e){return z(e)}):e&&e.startsWith("{{")?e.substring(2,e.indexOf(".")):e}function K(e,t,n){n&&n({processId:e,status:t?"done":"failed"})}function B(){var e=new Date;return J(e.getUTCFullYear(),4)+J(e.getUTCMonth()+1,2)+J(e.getUTCDate(),2)+"_"+J(e.getUTCHours(),2)+J(e.getUTCMinutes(),2)+"_"+J(e.getUTCSeconds(),2)+J(e.getUTCMilliseconds(),3)}function J(e,t){var n=e.toString(),r=t-n.length;return r>0&&(n="0".repeat(r)+n),n}function H(e,t){return void 0===t&&(t="id"),Array.isArray(e)?function(e,t){void 0===t&&(t="id");return e.map(function(e){return H(e,t)})}(e,t):e&&e.startsWith("{{")?e:"{{"+e+"."+t+"}}"}function $(e,t,r){return new Promise(function(i,o){j(n({item:{id:e,url:t}},r)).then(function(t){i(e)},function(e){return o(G(e))})})}function q(e,t){return t.split(".").reduce(function(e,t){return e?e[t]:void 0},e)}function V(e,t){return t.reduce(function(t,n){var r=q(e,n);return r&&t.push(r),t},[])}function Y(e,t){var n,r=[];if(!e)return r;for(n in e)e.hasOwnProperty(n)&&(n===t?r.push(e[n]):Array.isArray(e[n])?e[n].forEach(function(e){r=r.concat(Y(e,t))}):"object"==typeof e[n]&&(r=r.concat(Y(e[n],t))));return r}function Q(e,t){return(q(e,"item.typeKeywords")||e.typeKeywords||[]).includes(t)}function X(e){return void 0===e&&(e="i"),""+e+Math.random().toString(36).substr(2,8)}var Z="/apps/opsdashboard/index.html#/";function ee(e){var t=[],n=q(e,"data.widgets");return n&&n.forEach(function(e){"mapWidget"===e.type&&t.push(e.itemId)}),t}var te=Object.freeze({OPS_DASHBOARD_APP_URL_PART:Z,convertItemToTemplate:function(e,t){return new Promise(function(t){e.estimatedDeploymentCostFactor=4,W(e),e.item.url=L+Z,e.dependencies=ee(e),t(e)})},createItemFromTemplate:function(e,t,r,i){return i&&i({processId:e.key,type:e.type,status:"starting"}),new Promise(function(o,a){var u=n({item:e.item,folder:t.folderId},r);e.data&&(u.item.text=e.data),i&&i({processId:e.key,status:"creating"}),x(u).then(function(n){n.success?(t[e.itemId]={id:n.id},e.itemId=e.item.id=n.id,e=v(e,t),i&&i({processId:e.key,status:"updating URL"}),$(e.itemId,e.item.url,r).then(function(){K(e.key,!0,i),o(e)},function(t){K(e.key,!1,i),a(G(t))})):(K(e.key,!1,i),a(G()))},function(t){K(e.key,!1,i),a(G(t))})})},extractDependencies:ee});function ne(e,t,r){return new Promise(function(i,o){if(e.dependencies.length>0){var a=[];e.dependencies.forEach(function(i){a.push(new Promise(function(o,a){U(n({id:i,groupId:e.itemId},t)).then(function(){r&&r({processId:e.key,status:"added group member"}),o()},function(){K(e.key,!1,r),a({success:!1})})}))}),Promise.all(a).then(function(){return i()},function(e){return o(G(e))})}else i()})}function re(e,t){return new Promise(function(r,i){var o=n({paging:{start:1,num:100}},t);ie(e.itemId,o).then(function(t){e.estimatedDeploymentCostFactor=3+t.length,r(t)},function(e){return i(G(e))})})}function ie(e,t){return new Promise(function(r,i){(function(e,t){var r=k(t)+"/content/groups/"+e,i=n({httpMethod:"GET"},{params:{start:1,num:100}},t);return t&&t.paging&&(i.params=n({},t.paging)),T(r,i)})(e,t).then(function(n){if(n.num>0){var o=n.items.map(function(e){return e.id});n.nextStart>0?(t.paging.start=n.nextStart,ie(e,t).then(function(e){r(o.concat(e))},function(e){return i(G(e))})):r(o)}else r([])},function(e){return i(G(e))})})}var oe=Object.freeze({convertItemToTemplate:function(e,t){return new Promise(function(n,r){e.estimatedDeploymentCostFactor=3,W(e),re(e,t).then(function(t){e.dependencies=t,n(e)},function(e){return r(G(e))})})},createItemFromTemplate:function(e,t,r,i){return i&&i({processId:e.key,type:e.type,status:"starting"}),new Promise(function(o,a){var u=n({group:e.item},r);u.group.title+="_"+B(),i&&i({processId:e.key,status:"creating"}),C(u).then(function(n){n.success?(t[e.itemId]={id:n.group.id},e.itemId=n.group.id,ne(e=v(e,t),r,i).then(function(){K(e.key,!0,i),o(e)},function(t){K(e.key,!1,i),a(G(t))})):(K(e.key,!1,i),a(G()))},function(t){K(e.key,!1,i),a(G(t))})})},addGroupMembers:ne,getGroupContents:re,getGroupContentsTranche:ie});function ae(e){var t=S(e),r=k(e)+"/content/users/"+t+"/createService",i=n({},e,{rawResponse:!1});return i.params=n({createParameters:i.item,outputType:"featureService"},i.params),i.folderId&&"/"!==i.folderId?T(r,i).then(function(e){if(e.success)return(t={itemId:e.itemId,folderId:i.folderId,authentication:i.authentication},r=S(t),o=k(t)+"/content/users/"+r+"/items/"+t.itemId+"/move",a=t.folderId,a||(a="/"),t.params=n({folder:a},t.params),T(o,t)).then(function(t){if(t.success)return e;throw Error("A problem was encountered when trying to move the service to a different folder.")});throw Error("A problem was encountered when trying to create the service.");var t,r,o,a}):T(r,i)}function ue(e,t){var r=A(e).replace("/rest/services","/rest/admin/services")+"/addToDefinition";return t.params=n({addToDefinition:{}},t.params),t.layers&&t.layers.length>0&&(t.params.addToDefinition.layers=t.layers),t.tables&&t.tables.length>0&&(t.params.addToDefinition.tables=t.tables),T(r,t)}function se(e,t,r,i){return new Promise(function(o,a){var u=e.properties,s=[];(u.layers||[]).forEach(function(e){s[e.id]={item:e,type:"layer"}}),(u.tables||[]).forEach(function(e){s[e.id]={item:e,type:"table"}});var c={};s.length>0?function e(t,r,i,o,a,u,s,c){return new Promise(function(f,d){if(i.length>0){var m=i.shift(),l=m.item,p=l.id;delete l.serviceItemId,Array.isArray(l.relationships)&&l.relationships.length>0&&(a[p]=l.relationships,l.relationships=[]);var h=n({},u);"layer"===m.type?(l.adminLayerInfo={geometryField:{name:"Shape",srid:102100}},h.layers=[l]):h.tables=[l],ue(r,h).then(function(){c&&c({processId:s,status:"added layer"}),e(t,r,i,o,a,u,s,c).then(function(){return f()},function(e){return d(G(e))})},function(e){return d(G(e))})}else f()})}(e.itemId,e.item.url,s,t,c,r,e.key,i).then(function(){var t=[];Object.keys(c).forEach(function(o){t.push(new Promise(function(t,a){var u=n({params:{updateFeatureServiceDefinition:{relationships:c[o]}}},r);ue(e.item.url+"/"+o,u).then(function(){i&&i({processId:e.key,status:"updated relationship"}),t()},function(){return a()})}))}),Promise.all(t).then(function(){return o()},function(e){return a(G(e))})},function(e){return a(G(e))}):o()})}function ce(e){return e.reduce(function(e,t){return e+(t.relationships?t.relationships.length:0)},0)}function fe(e,t){return new Promise(function(n,r){var i={service:{},layers:[],tables:[]},o=e.item.url;e.item.url=H(e.itemId,"url"),T(o+"?f=json",t).then(function(a){a.serviceItemId=H(a.serviceItemId),i.service=a,Promise.all([de(o,a.layers,t),de(o,a.tables,t)]).then(function(t){i.layers=t[0],i.tables=t[1],e.properties=i,e.estimatedDeploymentCostFactor+=i.layers.length+ce(i.layers)+i.tables.length+ce(i.tables),n()},function(e){return r(G(e))})},function(e){return r(G(e))})})}function de(e,t,n){return new Promise(function(r,i){Array.isArray(t)&&0!==t.length||r([]);var o=[];t.forEach(function(t){o.push(T(e+"/"+t.id+"?f=json",n))}),Promise.all(o).then(function(e){e.forEach(function(e){e.editFieldsInfo=null,e.serviceItemId=H(e.serviceItemId)}),r(e)},function(e){return i(G(e))})})}var me=Object.freeze({convertItemToTemplate:function(e,t){return new Promise(function(n,r){e.estimatedDeploymentCostFactor=3,W(e),fe(e,t).then(function(){return n(e)},function(e){return r(G(e))})})},createItemFromTemplate:function(e,t,r,i){return i&&i({processId:e.key,type:e.type,status:"starting"}),new Promise(function(o,a){var u=n({item:e.item,folderId:t.folderId},r);e.data&&(u.item.text=e.data),u.item.name=e.item.name+"_"+B(),i&&i({processId:e.key,status:"creating"}),ae(u).then(function(u){t[e.itemId]={id:u.serviceItemId,url:u.serviceurl},e.itemId=e.item.id=u.serviceItemId,(e=v(e,t)).item.url=u.serviceurl,j(n({item:{id:e.itemId,title:e.item.title,snippet:e.item.snippet,description:e.item.description,accessInfo:e.item.accessInfo,licenseInfo:e.item.licenseInfo,text:e.data}},r)).then(function(){se(e,t,r,i).then(function(){K(e.key,!0,i),o(e)},function(t){K(e.key,!1,i),a(G(t))})},function(t){K(e.key,!1,i),a(G(t))})},function(t){K(e.key,!1,i),a(G(t))})})},addFeatureServiceLayersAndTables:se,countRelationships:ce,fleshOutFeatureService:fe,getLayers:de}),le="/home/webmap/viewer.html?webmap=";function pe(e){var t=[];return e.data&&(t=he(e.data.operationalLayers).concat(he(e.data.tables))),t}function he(e){return void 0===e&&(e=[]),e.reduce(function(e,t){var n=t.itemId;return n&&e.push(n),e},[])}function ye(e){void 0===e&&(e=[]),e.filter(function(e){return!!e.itemId}).forEach(function(e){var t=e.url.substr(e.url.lastIndexOf("/"));e.itemId=H(e.itemId),e.url=H(z(e.itemId),"url")+t})}var ve=Object.freeze({convertItemToTemplate:function(e,t){return new Promise(function(t){e.estimatedDeploymentCostFactor=4,W(e),e.item.url=L+le+H(e.itemId),e.dependencies=pe(e),e.data&&(ye(e.data.operationalLayers),ye(e.data.tables)),t(e)})},createItemFromTemplate:function(e,t,r,i){return i&&i({processId:e.key,type:e.type,status:"starting"}),new Promise(function(o,a){var u=n({item:e.item,folder:t.folderId},r);e.data&&(u.item.text=e.data),i&&i({processId:e.key,status:"creating"}),x(u).then(function(n){n.success?(t[e.itemId]={id:n.id},e.itemId=e.item.id=n.id,e=v(e,t),i&&i({processId:e.key,status:"updating URL"}),$(e.itemId,e.item.url,r).then(function(){K(e.key,!0,i),o(e)},function(t){K(e.key,!1,i),a(G(t))})):(K(e.key,!1,i),a(G()))},function(t){K(e.key,!1,i),a(G(t))})})},extractDependencies:pe,getWebmapLayerIds:he,templatizeWebmapLayerIdsAndUrls:ye});function ge(e){var t=function(e){return[]};return Q(e,"Cascade")&&(t=Ie),Q(e,"MapJournal")&&(t=be),Q(e,"mapseries")&&(t=we),t(e)}function Ie(e){return(q(e,"data.values.sections")||[]).reduce(function(e,t){return e.concat(Y(t,"webmap").map(function(e){return e.id}))},[])}function we(e){var t=V(e,["data.values.webmap"]);return(q(e,"data.values.story.entries")||[]).forEach(function(e){Y(e,"webmap").map(function(e){return e.id}).forEach(function(e){-1===t.indexOf(e)&&t.push(e)})}),t}function be(e){return(q(e,"data.values.story.sections")||[]).reduce(function(e,t){if(t.media){if("webmap"===t.media.type){var n=q(t,"media.webmap.id");n&&e.push(n)}if("webpage"===t.media.type){var r=function(e){var t=null;if(!e)return t;var n=e.split("?")[1];return n&&(t=n.split("&").reduce(function(e,t){var n,r=t.split("=")[1];return r&&"string"==typeof(n=r)&&("{"===n[0]&&(n=n.substring(1,n.length-1)),/^(\{){0,1}[0-9a-fA-F]{8}[-]?[0-9a-fA-F]{4}[-]?[0-9a-fA-F]{4}[-]?[0-9a-fA-F]{4}[-]?[0-9a-fA-F]{12}(\}){0,1}$/gi.test(n))&&(e=r),e},null)),t}(q(t,"media.webpage.url"));r&&e.push(r)}}return e},[])}function Oe(e){var t=[],n=q(e,"data.map.itemId");return n&&t.push(n),t}function Te(e){var t=Ee;return Q(e,"Story Map")&&(t=ge),function(e,t){var n=q(e,"item.typeKeywords")||e.typeKeywords||[];return t.reduce(function(e,t){return e||(e=n.includes(t)),e},!1)}(e,["WAB2D","WAB3D","Web AppBuilder"])&&(t=Oe),t(e)}function Ee(e){return V(e,["data.webmap","data.itemId","data.values.webmap","data.values.group"])}var Pe=Object.freeze({convertItemToTemplate:function(e,t){return new Promise(function(t){if(e.estimatedDeploymentCostFactor=4,W(e),e.item.url){var n=e.item.url,r=n.indexOf("//");e.item.url=L+n.substring(n.indexOf("/",r+2),n.lastIndexOf("=")+1)+H(e.itemId)}q(e,"data.folderId")&&(e.data.folderId="{{folderId}}"),e.dependencies=Te(e),q(e,"data.values.webmap")?e.data.values.webmap=H(e.data.values.webmap):q(e,"data.values.group")&&(e.data.values.group=H(e.data.values.group)),t(e)})},createItemFromTemplate:function(e,t,r,i){return i&&i({processId:e.key,type:e.type,status:"starting"}),new Promise(function(o,a){var u=n({item:e.item,folder:t.folderId},r);e.data&&(u.item.text=e.data),i&&i({processId:e.key,status:"creating"}),x(u).then(function(n){n.success?(t[e.itemId]={id:n.id},e.itemId=e.item.id=n.id,e=v(e,t),i&&i({processId:e.key,status:"updating URL"}),$(e.itemId,e.item.url,r).then(function(){K(e.key,!0,i),o(e)},function(t){K(e.key,!1,i),a(G(t))})):(K(e.key,!1,i),a(G()))},function(t){K(e.key,!1,i),a(G(t))})})},extractDependencies:Te,getGenericWebAppDependencies:Ee});var Ae=Object.freeze({convertItemToTemplate:function(e,t){return new Promise(function(t){W(e),t(e)})},createItemFromTemplate:function(e,t,r,i){return i&&i({processId:e.key,type:e.type,status:"starting"}),new Promise(function(o,a){var u=n({item:e.item,folder:t.folderId},r);e.data&&(u.item.text=e.data),i&&i({processId:e.key,status:"creating"}),x(u).then(function(n){n.success?(t[e.itemId]={id:n.id},e.itemId=e.item.id=n.id,K((e=v(e,t)).key,!0,i),o(e)):(K(e.key,!1,i),a(G()))},function(t){K(e.key,!1,i),a(G(t))})})}}),ke={dashboard:te,"feature service":me,group:oe,"web map":ve,"web mapping application":Pe};function Re(e,t){return new Promise(function(r,i){var o;(function(e,t){return T(k(t)+"/content/items/"+e,n({httpMethod:"GET"},t))})(e,t).then(function(a){ke[a.type.toLowerCase()]||console.warn("Unimplemented item type "+a.type+" for "+e),(o={itemId:a.id,type:a.type,key:X(),item:xe(a),dependencies:[],fcns:ke[a.type.toLowerCase()]||Ae,estimatedDeploymentCostFactor:3}).item.id=H(o.item.id),o.item.item&&(o.item.item=H(o.item.item)),o.item.thumbnail=t.portal+"/content/items/"+e+"/info/"+o.item.thumbnail;var u=function(e,t){var r=k(t)+"/content/items/"+e+"/data",i=n({httpMethod:"GET",params:{}},t);return i.file&&(i.params.f=null),T(r,i)}(e,t),s=function(e){var t=k(e)+"/content/items/"+e.id+"/resources";return e.params=n({},e.params,{num:1e3}),T(t,e)}(n({id:e},t));Promise.all([u.catch(function(){return null}),s.catch(function(){return null})]).then(function(n){var a=n[0],u=n[1];o.data=a,o.resources=u&&u.total>0?u.resources.map(function(n){return t.portal+"/content/items/"+e+"/resources/"+n.resource}):[],o.fcns.convertItemToTemplate(o,t).then(function(e){o.dependencies=Se(function(e){void 0===e&&(e=[]);return e.reduce(function(e,t){return e.concat(t)},[])}(e.dependencies)),r(o)},function(e){return i(G(e))})})},function(){_(e,t).then(function(n){(o={itemId:n.id,type:"Group",key:X(),item:xe(n),dependencies:[],fcns:ke.group,estimatedDeploymentCostFactor:3}).item.thumbnail=t.portal+"/community/groups/"+e+"/info/"+o.item.thumbnail,o.fcns.convertItemToTemplate(o,t).then(function(e){o.dependencies=Se(e.dependencies),r(o)},function(e){return i(G(e))})},function(e){return i(G(e))})})})}function Se(e){void 0===e&&(e=[]);var t={};return e.forEach(function(e){return t[e]=!0}),Object.keys(t)}function xe(e){if(e){var t=n({},e);return delete t.avgRating,delete t.created,delete t.guid,delete t.lastModified,delete t.modified,delete t.numComments,delete t.numRatings,delete t.numViews,delete t.orgId,delete t.owner,delete t.scoreCompleteness,delete t.size,delete t.uploaded,t}return null}var je;function Ce(e,t,n,r,i){var o=ze(e,t);return _e(t,o.folder,o.filename,n,r,i)}function _e(e,t,r,i,o,a){return void 0===t&&(t=null),new Promise(function(u,s){var c=n({rawResponse:!0},o);T(e,c).then(function(e){e.blob().then(function(e){var o,c,f,d=t?t+"/"+r:r,m=n({id:i,resource:e,name:r},a);t&&(m.params={resourcesPrefix:t}),(o=m,c=S(o),f=k(o)+"/content/users/"+c+"/items/"+o.id+"/addResources",o.params=n({file:o.resource,fileName:o.name,text:o.content,access:o.private?"private":"inherit"},o.params),T(f,o)).then(function(){return u(d)},function(e){return s(G(e))})},function(e){return s(G(e))})},function(e){return s(G(e))})})}function De(e,t,n,r,i,o){var a=e+"_info_thumbnail",u=t.substring(t.indexOf("/info/thumbnail/")+"/info/thumbnail/".length);return"Group"===n&&(a=e+"_info",u=t.substring(t.indexOf("/info/")+"/info/".length)),_e(t,a,u,r,i,o)}function Fe(e,t,n,r,i){return void 0===r&&(r={}),void 0===i&&(i="private"),new Promise(function(o,a){var u=t.item,s="https://www.arcgis.com/sharing/content/items/"+u.id+"/info/"+u.thumbnail;M({itemType:"text",name:null,title:e,description:u.description,tags:u.tags,snippet:u.snippet,thumbnailurl:s,accessInformation:u.accessInformation,type:"Solution",typeKeywords:["Solution","Deployed"],commentsEnabled:!1},null,n,r.folderId,i).then(function(e){var t=r.organization&&r.organization.orgUrl||"https://www.arcgis.com",n={id:e.id,url:t+"/home/item.html?id="+e.id};o(n)},function(e){return a(G(e))})})}function Ne(e,t,n,r,i){r[e]={};var o=new Promise(function(o,a){var u=Me(t,e);u||a(G());var s=[];(u.dependencies||[]).forEach(function(e){return s.push(r[e].def)}),Promise.all(s).then(function(){var u=function(e){return e.fcns=ke[e.type.toLowerCase()]||Ae,e}(Me(t,e));u.dependencies=u.dependencies?H(u.dependencies):[],(u=v(u,r)).fcns.createItemFromTemplate(u,r,n,i).then(function(e){return o(e)},function(e){return a(G(e))})},function(e){return a(G(e))})});return r[e].def=o,o}function Ue(e,t,n){return n||(n=[]),new Promise(function(r,i){if("string"==typeof e){var o=e;if(Me(n,o))r(n);else{var a=Re(o,t);n.push({itemId:o,type:"",key:"",item:null}),a.then(function(e){if(Ke(n,e.itemId,e),0===e.dependencies.length)r(n);else{var o=[];e.dependencies.forEach(function(e){Me(n,e)||o.push(Ue(e,t,n))}),Promise.all(o).then(function(){r(n)},function(e){return i(G(e))})}},function(e){return i(G(e))})}}else if(Array.isArray(e)&&e.length>0){var u=[];e.forEach(function(e){u.push(Ue(e,t,n))}),Promise.all(u).then(function(){r(n)},function(e){return i(G(e))})}else i(G())})}function Le(e,t,n,r,i){return void 0===r&&(r={}),void 0===i&&(i="private"),new Promise(function(o,a){var u={item:{itemType:"text",name:null,title:e,type:"Solution",typeKeywords:["Solution","Template"],commentsEnabled:!1},data:{metadata:{version:t},templates:[]}};M(u.item,u.data,n,r.folderId,i).then(function(e){var t=r.organization&&r.organization.orgUrl||"https://www.arcgis.com";u.item.id=e.id,u.item.url=t+"/home/item.html?id="+e.id,o(u)},function(e){return a(G(e))})})}function Ge(e,t,n,r){return void 0===n&&(n={}),void 0===r&&(r="private"),new Promise(function(i,o){var a={item:{itemType:"text",name:null,title:e,type:"Code Attachment",typeKeywords:["Solution","Template"],commentsEnabled:!1}};M(a.item,null,t,n.folderId,r).then(function(e){var t=n.organization&&n.organization.orgUrl||"https://www.arcgis.com";a.item.id=e.id,a.item.url=t+"/home/item.html?id="+e.id,i(a)},function(e){return o(G(e))})})}function We(e,t){var n=t;return e.findIndex(function(e){return n===e.itemId})}function Me(e,t){var n=We(e,t);return n>=0?e[n]:null}function ze(e,t){var n=e,r=t.substring(t.indexOf("/resources/")+"/resources/".length),i=r.split("/");return i.length>1&&(n+="_"+i[0],r=i[1]),{folder:n,filename:r}}function Ke(e,t,n){var r=We(e,t);return r>=0&&(e[r]=n,!0)}function Be(e,t,n,r){return new Promise(function(i,o){var a=[];e&&e.forEach(function(e){e.item.thumbnail&&a.push(De(e.itemId,e.item.thumbnail,e.type,t,n,r)),e.resources&&e.resources.forEach(function(i){a.push(Ce(e.itemId,i,t,n,r))})}),Promise.all(a).then(i,function(e){return o(G(e))})})}function Je(e){var t=[],n={};return e.forEach(function(e){n[e.itemId]=je.White}),e.forEach(function(r){n[r.itemId]===je.White&&function r(i){n[i]=je.Gray;var o=Me(e,i);var a=o.dependencies||[];a.forEach(function(e){if(n[e]===je.White)r(e);else if(n[e]===je.Gray)throw Error("Cyclical dependency graph detected")});n[i]=je.Black;t.push(i)}(r.itemId)}),t}function He(e){var t=e.map(function(e){return e.itemId});return e.forEach(function(e){(e.dependencies||[]).forEach(function(e){var n=t.indexOf(e);n>=0&&t.splice(n,1)})}),t}!function(e){e[e.White=0]="White",e[e.Gray=1]="Gray",e[e.Black=2]="Black"}(je||(je={})),e.createSolutionItem=function(e,t,r,i,o){return new Promise(function(a,u){o||(o=i),Le(e,t,o,void 0,"public").then(function(e){Ue(r,i).then(function(t){e.data.templates=t,Ge(e.item.title,o,void 0,"public").then(function(t){e.data.metadata.resourceStorageItemId=t.item.id;var r=Be(e.data.templates,t.item.id,i,o),s=function(e,t){return new Promise(function(r,i){(function(e,t,r){return new Promise(function(i,o){j(n({item:{id:e,text:t}},r)).then(function(t){i(e)},function(e){return o(G(e))})})})(e.item.id,e.data,t).then(function(){return r(e)},function(e){return i(G(e))})})}(e,o);Promise.all([r,s]).then(function(t){a(e)},function(e){return u(G(e))})},function(e){return u(G(e))})},function(e){return u(G(e))})},function(e){return u(G(e))})})},e.deploySolutionItem=function(e,t,r,i){return void 0===r&&(r={}),new Promise(function(o,a){var u=q(e,"data.templates");r.solutionName=r.solutionName||"Solution",u&&0!==Object.keys(u).length||o([]);var s=Je(u);function c(){Fe(r.solutionName,e,t,r,"public").then(function(e){var n;i&&i({processId:e.id,type:"Solution",status:"done"}),n=[],s.forEach(function(e){return n.push(Ne(e,u,t,r,i))}),Promise.all(n).then(function(e){return o(e)},function(e){return a(G(e))})},function(e){return a(G(e))})}r.folderId?c():function(e){var t=S(e),r=k(e)+"/content/users/"+t+"/createFolder";return e.params=n({title:e.title},e.params),T(r,e)}({title:r.solutionName+" ("+B()+")",authentication:t.authentication}).then(function(e){r.folderId=e.folder.id,c()},function(e){return a(G(e))})})},e.getEstimatedDeploymentCost=function(e){return e.reduce(function(e,t){return e+(t.estimatedDeploymentCostFactor?t.estimatedDeploymentCostFactor:3)},0)},e.getSupportedItemTypes=function(){return Object.keys(ke)},e.PLACEHOLDER_SERVER_NAME="{{organization.portalBaseUrl}}",e.OPS_DASHBOARD_APP_URL_PART="/apps/opsdashboard/index.html#/",e.WEBMAP_APP_URL_PART="/home/webmap/viewer.html?webmap=",e.copyRegularResource=Ce,e.copyResource=_e,e.copyThumbnailResource=De,e.createDeployedSolutionAgoItem=Fe,e.createItemFromTemplateWhenReady=Ne,e.createItemTemplates=Ue,e.createSolutionAgoItem=Le,e.createSolutionStorageAgoItem=Ge,e.findTemplateInList=Me,e.getFolderAndFilenameForResource=ze,e.publishSolutionTemplate=function(e,t,n,r,i){return void 0===r&&(r=null),void 0===i&&(i="private"),M({title:e,type:"Solution",itemType:"text",typeKeywords:["Template"],access:i,listed:!1,commentsEnabled:!1},{templates:t},n,r,i)},e.replaceTemplate=Ke,e.saveResourcesInSolutionItem=Be,e.topologicallySortItems=Je,e.getItemHierarchy=function(e){var t=[];return function t(n,r){n.forEach(function(n){var i={id:n,dependencies:[]},o=Me(e,n).dependencies;Array.isArray(o)&&o.length>0&&t(o,i.dependencies),r.push(i)})}(He(e),t),t},e.getTopLevelItemIds=He,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=arcgis-clone.umd.min.js.map
